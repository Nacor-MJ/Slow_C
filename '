#include <stdio.h>
#include <stdlib.h>

#include "parser.c"
#include "tests.c"
// #define DBG 1

char* load_file(char const* path)
{
    char* buffer = 0;
    long length;
    FILE * f = fopen (path, "rb");

    if (f)
    {
      fseek (f, 0, SEEK_END);
      length = ftell (f);
      fseek (f, 0, SEEK_SET);
      buffer = (char*)malloc ((length+1)*sizeof(char));
      if (buffer)
      {
        fread (buffer, sizeof(char), length, f);
      }
      fclose (f);
    }
    buffer[length] = '\0';

    return buffer;
}

void compile(char* file_path, char* ir) {
    // Compiling ig
    char out[64] = "";
    strncpy(out, file_path, 60);
    strcat(out, ".S");

    FILE* fptr = fopen(out, "w");
    fprintf(fptr, "\t.text \n\t.globl main\n\t.intel_syntax\n\tnoprefix\n\t.def\tmain\nmain:\n" );
    fprintf(fptr, ir);
    fprintf(fptr, "\tret\n");
    fclose(fptr);
    
    char ass[128] = "";
    char link[128] = "";

    sprintf(ass, "gcc -c %s.S -o %s.o", file_path, file_path);
    sprintf(link, "gcc %s.o -o %s.exe", file_path, file_path);

    // assembly
    if (0 != system(ass)) {
        printf("Failed to assemble %s\n", file_path);
        exit(-1);
    }
    printf("Successfully assembled\n");

    // linking
    if (0 != system(link)){
        printf("Failed to link %s\n", file_path);
        exit(-1);
    }

    printf("Successfully compiled %s\n", file_path);
}

int main(int argc, char *argv[]) {
    if (argc < 2){
        printf("Failed to provide program name\n");
        exit(-1);
    }
    if (argc > 2 && strcmp("-E", argv[1])) {

    }
    

    char* file_path = argv[1];

    if (strcmp(file_path, "--test") == 0){
        test();
        return 0;
    }
    
    printf("Compiling %s\n", file_path);

    char* buff = load_file(file_path);;

    printf("Src: %s\n", buff);

    Node* nd = (Node*) malloc(sizeof(Node));

    *nd = parse(buff);

    Instruction* start = empty_instruction();

    start->next = NULL;

    node_to_ir(nd, start, RAX);

    char ir[256] = {'\0'};
    inst_seq_to_char(start, ir);

    char out[64] = ""; // filename 
    strncpy(out, file_path, strlen(file_path) - 4);
    compile(out, ir);

    free_node_children(nd);
    free_instr_and_children(start);
    free(buff);
	return 0;
}
